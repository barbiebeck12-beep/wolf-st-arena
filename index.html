<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WOLF STREET: CPU ARENA (Progress Bar Model)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css?family=Press+Start+2P&family=Rubik+Mono+One&display=swap');

        :root {
            --neon-pink: #ff00ff;
            --neon-cyan: #00ffff;
            --neon-yellow: #ffff00;
            --neon-green: #00ff00;
            --neon-red: #ff0000;
            --dark-blue: #0f0f23;
            --deep-purple: #330033;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background-color: var(--dark-blue);
            margin: 0;
            padding: 20px;
            color: #fff;
            overflow-x: hidden;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(255,0,255,0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(0,255,255,0.1) 0%, transparent 20%);
        }

        #game-container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(0,0,30,0.9);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 0 40px var(--neon-cyan);
            border: 2px solid var(--neon-cyan);
        }

        .text-shadow-neon {
            text-shadow: 0 0 5px var(--neon-cyan), 0 0 10px var(--neon-cyan);
        }

        .bot-card {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
        }

        .modal-backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 60;
        }

        .modal { background: #0b0b18; padding: 20px; border: 2px solid var(--neon-pink); border-radius: 8px; width: 420px; }
    </style>
</head>
<body>
    <div id="game-container">
        <h1 class="text-3xl text-center mb-6 text-[var(--neon-yellow)] font-mono text-shadow-neon">
            WOLF STREET: CPU ARENA
        </h1>

        <div id="game-status" class="p-4 mb-6 rounded-lg font-mono text-center text-sm"
            style="background-color: rgba(0, 50, 50, 0.6); border: 2px solid var(--neon-cyan);">
            <span id="current-turn-display">Awaiting simulation start...</span>
        </div>

        <!-- Visualizer and Controls Side-by-Side on Desktop -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">

            <!-- LIVE ACTION VISUALIZER & MAP CONTAINER -->
            <div>
                <div id="visualizer" class="p-4 rounded-xl mb-4" style="background-color: rgba(0,0,0,0.6); border: 2px solid var(--neon-cyan);">
                    <div id="visualizer-text" class="text-lg mt-4 text-center text-[var(--neon-yellow)] font-mono">
                        Simulation Paused.
                    </div>
                </div>

                <!-- NEW: WOLF STREET MAP -->
                <div class="w-full h-48 relative rounded-lg p-2" id="map-container">
                    <h3 class="text-xs text-[var(--neon-pink)] font-mono mb-1 text-center absolute top-0 left-1/2 transform -translate-x-1/2 z-20">WOLF STREET Map</h3>
                    <!-- Location Markers and Player Tokens will be rendered here by JS -->
                </div>
            </div>

            <!-- Bot Arena Controls (Original content) -->
            <div id="bot-arena-controls" class="p-4 rounded-xl shadow-xl border-2" 
                style="background-color: rgba(0,0,30,0.8); border-color: var(--neon-cyan);">

                <h2 class="text-xl font-bold text-[var(--neon-cyan)] mb-3 pb-2 border-b border-[var(--neon-cyan)]">
                    <span class="text-shadow-neon">CPU Player Generator & Controls</span>
                </h2>

                <div class="flex space-x-3 mb-4">
                    <button id="toggleBotBtn" class="flex-1 py-2 px-3 rounded-lg font-bold transition duration-300" 
                            style="background-color: var(--neon-green); color: black; box-shadow: 0 0 5px var(--neon-green);">
                        <span class="mr-1">▶️</span> Start Simulation
                    </button>
                    <button id="resetBtn" class="py-2 px-3 rounded-lg font-bold transition duration-300 w-1/4"
                            style="background-color: var(--neon-red); color: white; box-shadow: 0 0 5px var(--neon-red);">
                        Reset
                    </button>
                </div>

                <button id="generateBotBtn" class="w-full py-2 mb-4 rounded-lg font-bold transition duration-300"
                        style="background-color: var(--deep-purple); color: var(--neon-pink); border: 2px solid var(--neon-pink); box-shadow: 0 0 8px var(--neon-pink);">
                    <span class="mr-1">➕</span> Generate New CPU Player
                </button>

                <div class="mb-2">
                    <label for="botSpeed" class="block text-xs font-medium text-white mb-1">
                        Decision Speed (ms per tick): <span id="speedValue" class="text-[var(--neon-yellow)] font-mono">1000</span>
                    </label>
                    <input type="range" id="botSpeed" min="500" max="5000" value="1000" step="500" 
                            class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                            style="accent-color: var(--neon-cyan);">
                </div>
            </div>
        </div>

        <h2 class="text-xl font-bold text-[var(--neon-yellow)] mt-8 mb-3 text-shadow-neon">
            Active Players
        </h2>
        <div id="player-cards-container" class="grid gap-4">
            </div>

        <div class="mt-8 p-4 rounded-xl border-2 border-[var(--neon-pink)]" style="background-color: rgba(0,0,0,0.6);">
            <h3 class="text-base font-bold text-[var(--neon-pink)] mb-2">Simulation Log</h3>
            <div id="game-log" class="h-40 overflow-y-auto font-mono text-gray-300">
                </div>
        </div>
    </div>

    <!-- Authentication & Account Modal (client-side localStorage based) -->
    <div id="authModal" class="hidden modal-backdrop">
        <div class="modal">
            <h3 id="authTitle" class="text-[var(--neon-pink)] font-bold mb-2">Sign Up / Login</h3>
            <div id="authForm">
                <label class="text-xs">Email</label>
                <input id="emailInput" class="w-full p-2 mb-2 rounded" />
                <label class="text-xs">Password</label>
                <input id="passwordInput" type="password" class="w-full p-2 mb-2 rounded" />
                <label class="text-xs">Display Name</label>
                <input id="displayNameInput" class="w-full p-2 mb-2 rounded" />
                <label class="text-xs">Solana Wallet Address</label>
                <input id="solanaInput" class="w-full p-2 mb-2 rounded" placeholder="Enter Solana public key" />
                <div class="flex space-x-2 mt-2">
                    <button id="signupBtn" class="flex-1 py-2 rounded bg-[var(--neon-green)] text-black font-bold">Sign Up</button>
                    <button id="loginBtn" class="flex-1 py-2 rounded bg-[var(--neon-cyan)] text-black font-bold">Login</button>
                </div>
                <div class="mt-3 text-xs text-gray-300">Note: This demo stores account info in your browser (localStorage). For production you should implement server-side accounts and PayPal verification.</div>
            </div>
        </div>
    </div>

    <script>
        // --- SIMPLE CLIENT-SIDE AUTH (localStorage) ---
        // Data model in localStorage: users: { email -> {email, password, displayName, solana, paid, cpus: [] }}
        const PAYPAL_LINK = 'https://www.paypal.com/ncp/payment/2FVDHG9V2ZDQE';

        function openAuthModal() { document.getElementById('authModal').classList.remove('hidden'); }
        function closeAuthModal() { document.getElementById('authModal').classList.add('hidden'); }

        function getUsers() { try { return JSON.parse(localStorage.getItem('wsa_users')||'{}'); } catch(e){return{}} }
        function setUsers(u){ localStorage.setItem('wsa_users', JSON.stringify(u)); }

        function getCurrentUserEmail(){ return localStorage.getItem('wsa_current') || null; }
        function setCurrentUserEmail(e){ if(e) localStorage.setItem('wsa_current', e); else localStorage.removeItem('wsa_current'); }

        function signup(email, password, displayName, solana) {
            const users = getUsers();
            if(users[email]) { alert('Account already exists, try login'); return false; }
            users[email] = { email, password, displayName, solana, paid: false, cpus: [] };
            setUsers(users);
            setCurrentUserEmail(email);
            updateUIState();
            closeAuthModal();
            return true;
        }

        function login(email, password) {
            const users = getUsers();
            if(!users[email] || users[email].password !== password) { alert('Invalid credentials'); return false; }
            setCurrentUserEmail(email);
            updateUIState();
            closeAuthModal();
            return true;
        }

        function logout() { setCurrentUserEmail(null); updateUIState(); }

        function getCurrentUser() { const email = getCurrentUserEmail(); const users = getUsers(); return email ? users[email] : null; }

        function requireLogin(flowName = 'access this feature') {
            const u = getCurrentUser();
            if(!u) { if(confirm('You must be logged in to ' + flowName + '. Open login?')) openAuthModal(); return false; }
            if(!u.solana) { if(confirm('Please add your Solana wallet in account settings. Open account modal?')) openAuthModal(); return false; }
            return true;
        }

        // --- CPU ownership, payment check ---
        function userHasPaid() { const u = getCurrentUser(); return u && u.paid; }

        function markUserPaid() { const user = getCurrentUser(); if(!user) return; const users = getUsers(); users[user.email].paid = true; setUsers(users); updateUIState(); }

        function addCpuToUser(cpu) { const user = getCurrentUser(); if(!user) return; const users = getUsers(); users[user.email].cpus.push(cpu); setUsers(users); updateUIState(); }

        // --- Existing game code (kept / adapted) ---
        const IMAGE_MAP = {
            'jordi': 'uploaded:jordi.jpg-5ba732dd-a17b-44ff-b00b-de1220e7c21f',
            'mark': 'uploaded:toon mark.jpg-3d87fdf5-bd45-45f5-b740-19dc046f4063',
            'donnie': 'uploaded:toon donnie.jpg-2132310e-0c06-4b26-87e9-a761e6549506',
            'brad_kim': 'uploaded:brad kim toon.jfif-d2607ba2-b9be-48a8-9034-8fc2df1a5286'
        };

        const STRATEGIES = {
            'SURVIVOR': { name: 'The Survivor', logic: survivorBotDecision, imageKey: 'jordi' },
            'GRIND_WOLF': { name: 'The Grind Wolf (Cold Caller)', logic: grindWolfDecision, imageKey: 'donnie' },
            'SOCIALITE': { name: 'The Socialite', logic: socialiteDecision, imageKey: 'mark' },
        };
        const STRATEGY_KEYS = Object.keys(STRATEGIES);

        const LOCATIONS = ['home', 'office', 'market', 'gym', 'club', 'phone'];
        const BASE_PLAYER_STATE = {
            cash: 500, energy: 70, location: 'home', isDriving: false, isBusy: false, busyFinishTick: 0, currentActionDuration: 0, currentAction: 'IDLE', currentActionMessage: 'Awaiting instruction...', strategy: '', id: 0
        };

        let players = [];
        let isSimulating = false;
        let botIntervalId = null;
        let currentBotSpeed = 1000;
        let turnIndex = 0;
        let nextPlayerId = 1;
        let currentTick = 0;

        // DOM elements
        const currentTurnDisplay = document.getElementById('current-turn-display');
        const gameLogElement = document.getElementById('game-log');
        const toggleBotBtn = document.getElementById('toggleBotBtn');
        const resetBtn = document.getElementById('resetBtn');
        const generateBotBtn = document.getElementById('generateBotBtn');
        const botSpeedRange = document.getElementById('botSpeed');
        const speedValueDisplay = document.getElementById('speedValue');
        const playerCardsContainer = document.getElementById('player-cards-container');
        const visualizerText = document.getElementById('visualizer-text');

        function logAction(name, msg){ const el = document.getElementById('game-log'); el.innerHTML = `<div class="mb-1">${name}: ${msg}</div>` + el.innerHTML; }

        function getRandomElement(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

        function generateNewBot(initial = false) {
            // payment & auth gating: require logged in and paid
            if(!requireLogin('generate a CPU')) return;
            if(!userHasPaid()){
                if(confirm('Generating a CPU requires payment. Open PayPal checkout?')){
                    // Open PayPal link in new tab and offer mark-as-paid manual flow
                    window.open(PAYPAL_LINK, '_blank');
                    if(confirm('After completing the PayPal flow, click OK to mark your account as paid (manual). Use server-side verification in production.')){
                        markUserPaid();
                    }
                }
                return;
            }

            const strategyKey = getRandomElement(STRATEGY_KEYS);
            const strategy = STRATEGIES[strategyKey];
            const newBot = {
                ...BASE_PLAYER_STATE,
                name: strategy.name + ' ' + nextPlayerId,
                strategy: strategyKey,
                id: nextPlayerId,
                cash: initial ? BASE_PLAYER_STATE.cash : Math.floor(Math.random()*1000)+100,
                energy: initial ? BASE_PLAYER_STATE.energy : Math.floor(Math.random()*50)+50,
            };
            players.push(newBot);
            addCpuToUser({ id: newBot.id, name: newBot.name, strategy: strategyKey, created_at: new Date().toISOString() });
            nextPlayerId++;
            renderPlayers();
            logAction('System', `Generated CPU ${newBot.name} for ${getCurrentUser().email}`);
        }

        // placeholder strategy decision functions
        function survivorBotDecision(player){ if(player.isBusy) return true; if(player.energy<40){ if(player.location!=='home') return travel(player,'home'); if(player.energy<70) return sleep(player);} if(player.cash<1000){ if(player.location!=='office') return travel(player,'office'); if(player.energy>20) return work(player);} if(player.location==='home') return sleep(player); return false; }
        function socialiteDecision(player){ if(player.isBusy) return true; if(player.energy<30){ if(player.location!=='home') return travel(player,'home'); return sleep(player);} if(player.cash<500){ if(player.location!=='office') return travel(player,'office'); return work(player);} if(player.location!=='club') return travel(player,'club'); if(player.cash>=200) return party(player); return false; }
        function grindWolfDecision(player){ if(player.isBusy) return true; if(player.energy<20){ if(player.location!=='home') return travel(player,'home'); return sleep(player);} if(player.cash<5000){ if(player.location!=='phone') return travel(player,'phone'); if(player.energy>15) return coldCall(player);} if(player.cash>=5000){ if(player.location!=='market') return travel(player,'market'); if(player.location!=='home') return travel(player,'home'); return false; }

        // stub action functions
        function travel(player, dest){ player.location = dest; player.isBusy = true; player.busyFinishTick = currentTick + 2; player.currentAction = 'TRAVEL'; player.currentActionDuration = 2; return true; }
        function sleep(player){ player.energy = Math.min(100, player.energy + 30); player.isBusy=true; player.busyFinishTick = currentTick+3; player.currentAction='SLEEP'; player.currentActionDuration=3; return true; }
        function work(player){ player.cash += 200; player.isBusy=true; player.busyFinishTick = currentTick+3; player.currentAction='WORK'; player.currentActionDuration=3; return true; }
        function coldCall(player){ player.cash += 50; player.isBusy=true; player.busyFinishTick=currentTick+1; player.currentAction='COLD_CALL'; player.currentActionDuration=1; return true; }
        function invest(player){ player.cash += Math.floor(Math.random()*400)-50; player.isBusy=true; player.busyFinishTick=currentTick+3; player.currentAction='INVEST'; player.currentActionDuration=3; return true; }
        function party(player){ player.energy -= 20; player.cash -= 100; player.isBusy=true; player.busyFinishTick=currentTick+2; player.currentAction='PARTY'; player.currentActionDuration=2; return true; }

        function renderPlayers(){ playerCardsContainer.innerHTML = players.map(player=>{ const strategy = STRATEGIES[player.strategy]; let statusText = player.isBusy ? player.currentAction : 'IDLE'; let progressHtml=''; return `
                    <div class="bot-card p-4 flex items-center transition duration-300">
                        <div class="avatar mr-4">
                            <div class="w-12 h-12 rounded-full bg-[var(--neon-pink)] flex items-center justify-center">W</div>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-sm font-bold mb-1 text-[var(--neon-pink)]">${player.name} (ID: ${player.id})</h4>
                            <p class="text-xs text-gray-400 font-mono">${strategy.name}</p>
                        </div>
                        <div class="ml-4 text-right text-xs font-mono">
                            <p class="text-white">Cash: <span class="text-[var(--neon-green)]">$${player.cash.toFixed(2)}</span></p>
                            <p class="text-white">Energy: <span class="${player.energy<40? 'text-[var(--neon-red)]' : 'text-white'}">${player.energy}%</span></p>
                            <p class="text-white">Status: <span class="text-[var(--neon-cyan)]">${statusText}</span></p>
                        </div>
                    </div>
                `; }).join(''); }

        function simulateTurn(){ if(!isSimulating || players.length===0) return; currentTick++; const player = players[turnIndex]; currentTurnDisplay.textContent = `TICK: ${currentTick} | Current Player: ${player.name}`; if(player.isBusy){ if(currentTick>=player.busyFinishTick){ player.isBusy=false; player.currentAction='IDLE'; } turnIndex=(turnIndex+1)%players.length; renderPlayers(); return; } const decisionFunction = STRATEGIES[player.strategy].logic; const madeDecision = decisionFunction(player); if(!madeDecision){ player.currentAction='IDLE'; player.currentActionMessage='Decided to wait.'; } turnIndex=(turnIndex+1)%players.length; renderPlayers(); }

        function toggleSimulation(){ isSimulating = !isSimulating; if(isSimulating){ if(botIntervalId) clearInterval(botIntervalId); simulateTurn(); botIntervalId = setInterval(simulateTurn, currentBotSpeed); } else { clearInterval(botIntervalId); botIntervalId = null; } updateUIState(); }
        function resetGame(){ if(botIntervalId) clearInterval(botIntervalId); isSimulating=false; botIntervalId=null; players=[]; nextPlayerId=1; createInitialPlayers(); renderPlayers(); updateUIState(); }

        function createInitialPlayers(){ for(let i=0;i<3;i++){ const s = getRandomElement(STRATEGY_KEYS); players.push({ ...BASE_PLAYER_STATE, name: STRATEGIES[s].name+' '+(nextPlayerId), strategy:s, id: nextPlayerId, cash: Math.floor(Math.random()*500)+200, energy: Math.floor(Math.random()*50)+50 }); nextPlayerId++; } }

        // UI wiring
        window.addEventListener('load', ()=>{
            createInitialPlayers();
            toggleBotBtn.addEventListener('click', toggleSimulation);
            resetBtn.addEventListener('click', resetGame);
            generateBotBtn.addEventListener('click', ()=>generateNewBot(false));
            botSpeedRange.min = 500; botSpeedRange.max = 5000; botSpeedRange.step = 500; botSpeedRange.value = 1000;
            botSpeedRange.addEventListener('input',(e)=>{ currentBotSpeed = parseInt(e.target.value,10); speedValueDisplay.textContent = currentBotSpeed; if(isSimulating){ clearInterval(botIntervalId); botIntervalId = setInterval(simulateTurn, currentBotSpeed); } });
            updateUIState();
        });

        // Auth modal handlers
        document.getElementById('signupBtn').addEventListener('click', ()=>{
            const email = document.getElementById('emailInput').value.trim();
            const pw = document.getElementById('passwordInput').value;
            const dn = document.getElementById('displayNameInput').value.trim();
            const sol = document.getElementById('solanaInput').value.trim();
            if(!email||!pw){ alert('Email and password required'); return; }
            // Basic solana-ish format check: base58-ish length (not strict)
            if(sol && sol.length < 32) { if(!confirm('Solana address looks short. Continue anyway?')) return; }
            signup(email,pw,dn,sol);
        });
        document.getElementById('loginBtn').addEventListener('click', ()=>{
            const email = document.getElementById('emailInput').value.trim();
            const pw = document.getElementById('passwordInput').value;
            if(!email||!pw){ alert('Email and password required'); return; }
            login(email,pw);
        });

        function updateUIState(){ const user = getCurrentUser(); if(user){ document.getElementById('generateBotBtn').textContent = '➕ Generate New CPU Player (Paid)'; } else { document.getElementById('generateBotBtn').textContent = '➕ Generate New CPU Player'; }
            // display basic account button
            if(!document.getElementById('accountBtn')){
                const btn = document.createElement('button'); btn.id='accountBtn'; btn.className='fixed top-4 right-4 py-2 px-3 rounded bg-[var(--neon-pink)] text-black font-bold';
                document.body.appendChild(btn);
                btn.addEventListener('click', ()=>{ const u=getCurrentUser(); if(u) { if(confirm('Logout?')) logout(); else openAuthModal(); } else openAuthModal(); });
            }
            const ab = document.getElementById('accountBtn'); if(getCurrentUser()){ ab.textContent = getCurrentUser().email + (userHasPaid()? ' (PAID)':' (UNPAID)'); } else { ab.textContent = 'Login / Sign Up'; }
        }

    </script>
</body>
</html>
